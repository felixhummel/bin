#!/bin/bash
set -euo pipefail

tmp=$(mktemp)

finally() {
  rm "$tmp"
}
trap finally EXIT

url="$1"
srt_dir=$(mktemp -d)

id=$(yt-dlp --skip-download --print "%(id)s" "$url")

# https://github.com/yt-dlp/yt-dlp/issues/9165#issuecomment-3792902294
yt-dlp -q --remote-components ejs:github --skip-download --write-auto-subs --convert-subs srt -P "$srt_dir" -o "s" "$url" &&
  sed -E '/^[0-9]+$/d; /-->/d; s/<[^>]*>//g; /^$/d' "$srt_dir"/s.*.srt |
    dos2unix |
    uniq -u |
    paste -s -d "" > "$tmp"
rm -rf "$srt_dir"

rsync -az --chmod=D755,F644 "$tmp" "sf:/var/www/felixhummel.de/pub/yt-transcripts/${id}.txt"
echo "https://www.felixhummel.de/pub/yt-transcripts/${id}.txt" >&2
echo >&2
cat "$tmp"
