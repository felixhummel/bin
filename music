#!/usr/bin/env python
# encoding: utf-8
import logging
import os

import click
import dbus

logging.basicConfig(level=os.environ.get('LOGLEVEL', 'INFO').upper())
log = logging.getLogger('music')


try:
    from dbus import DBusException
except ImportError:
    from dbus.exceptions import DBusException


def get_player():
    bus = dbus.SessionBus()
    candidates = [n for n in bus.list_names() if n.startswith('org.mpris.MediaPlayer2')]
    count = len(candidates)
    if count != 1:
        log.warning(f'count = {count}')
    for c in candidates:
        log.debug(f'found {c}')
    name = candidates[0]
    log.info(f'using {name}')
    proxy = bus.get_object(name, '/org/mpris/MediaPlayer2')
    return dbus.Interface(proxy, dbus_interface='org.mpris.MediaPlayer2.Player')


@click.command()
@click.argument('what', type=click.Choice(['PlayPause', 'Previous', 'Next']))
def main(what):
    player = get_player()
    method = player.get_dbus_method(what)
    method()


if __name__ == '__main__':
    main()
