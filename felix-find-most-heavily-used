#!/bin/bash
# shellcheck disable=SC2086
set -euo pipefail

# Claude says:
# The formula count * 1000 / (days_ago + 1):
#  - A file touched 10 times yesterday scores 10000
#  - A file touched 10 times 30 days ago scores ~323
#  - A file touched 50 times a year ago scores ~136
#
#  The 1000 multiplier keeps scores as readable integers rather than 0 for infrequently-touched old files.

pattern="$1"
dir="${2:-.}"

today=$(date +%s)
echo -e "score\td_ago\tcount\tpath"
fd -g "$pattern" "$dir" | while read -r f; do
    dir=$(git -C "$(dirname "$f")" rev-parse --show-toplevel 2>/dev/null) || continue
    count=$(git -C "$dir" log --oneline --author=felix -- "$f" 2>/dev/null | wc -l || true)
    [[ "$count" == 0 ]] && continue
    last_ts=$(git -C "$dir" log -1 --format="%at" --author=felix -- "$f" 2>/dev/null)
    days_ago=$(( (today - last_ts) / 86400 ))
    score=$(( count * 1000 / (days_ago + 1) ))
    printf "%4d\t${days_ago}\t$count\t$f\n" "$score"
done | sort -rn | head -20
